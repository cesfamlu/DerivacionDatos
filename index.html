<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Derivaciones Médicas - CESFAM La Unión</title>
    
    <!-- (Req #1) Tipografía Inter real -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- (Req #1) Bootstrap 5 CSS (sin xintegrity) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- (Req #1) Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --color-primary: #0d6efd;
            --color-success: #198754;
            --color-info: #0dcaf0;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-medical: #2c5f7d;
            --color-medical-light: #4a90b8;
            
            /* (Req #2) CSS Tokens */
            --radius-lg: 14px;
            --shadow-1: 0 2px 8px rgba(0,0,0,.06);
            --shadow-2: 0 8px 24px rgba(0,0,0,.12);
            /* (Req #2) Densidad compacta opcional */
            --pad-y:.9rem; 
            --pad-x:1.1rem;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* (Req #2) Afinar tipografía */
        h1,h2,h3{ letter-spacing: -.02em }
        .lead{ color:#eef6ff; opacity:.9 }

        /* (Req #2) Header + Franja institucional */
        .header-section {
            background: linear-gradient(135deg, var(--color-medical) 0%, #356f93 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            position: relative; 
            border-bottom: none;
        }
        
        .header-section::after{
          content:""; 
          position:absolute; left:0; right:0; bottom:0; height:6px;
          background: linear-gradient(90deg, var(--color-warning), var(--color-primary));
          opacity:.95;
        }

        .header-section h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .header-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .filter-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-1);
            margin-bottom: 2rem;
        }

        .search-input {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 0.6rem 1rem;
            transition: all 0.3s ease;
            background: #fff; 
           
        }

        .search-input:focus {
            border-color: var(--color-medical);
            box-shadow: 0 0 0 0.2rem rgba(44, 95, 125, 0.15);
        }

        .filter-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 0.6rem 1rem;
            transition: all 0.3s ease;
            background: #fff; 
           
        }

        .filter-select:focus {
            border-color: var(--color-medical);
            box-shadow: 0 0 0 0.2rem rgba(44, 95, 125, 0.15);
        }

        /* (Req #2) Botones filtro: estado activo más claro */
        .btn-filter {
            border-radius: 10px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #333;
            border:1.5px solid rgba(13,110,253,.15);
            background:#fff;
        }

        .btn-filter.active{
            background: linear-gradient(135deg,#eaf2ff,#dbeafe);
            border-color: var(--color-primary);
            color: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-outline-success, .btn-outline-primary, .btn-outline-danger, .btn-outline-secondary {
          border-width: 1.5px
        }
        .btn-outline-success:active, .btn-outline-primary:active, .btn-outline-danger:active, .btn-outline-secondary:active {
          transform: translateY(1px);
        }

        /* (Req #3) KPI Bar */
        .results-info {
            background: white;
            border-radius: 10px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
        }

        /* (Req #2) Cards */
        .card-referral {
            border: none;
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-1);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative; /* (Req #2) */
        }
        
        /* (Req #2) Banda de color por tipo */
        .card-referral::before{
          content:""; 
          position:absolute; 
          inset:0 0 auto 0; 
          height:4px; 
          display:block;
          background: var(--tipo-color, var(--color-medical));
        }

        .card-referral:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-2);
        }

        /* (Req #2) Card Header Compacto */
        .card-header-custom {
            padding: .75rem 1rem;
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            background: #fff;
        }

        .badge-tipo-especialidad {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .badge-tipo-procedimiento {
            background: linear-gradient(135deg, #06beb6 0%, #48b1bf 100%);
        }

        .badge-tipo-patologia {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .badge-ges-si {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #000;
        }

        .badge-ges-no {
            background: linear-gradient(135deg, #868f96 0%, #596164 100%);
        }

        /* (Req #2) Badges ligeramente menos saturadas */
        .badge-custom {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
            filter: saturate(.92);
        }

        .card-body-custom {
            padding: var(--pad-y) var(--pad-x);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .card-body-custom .info-container {
            flex-grow: 1;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .info-row i {
            font-size: 1.2rem;
            margin-right: 0.75rem;
            color: var(--color-medical);
            min-width: 25px;
            padding-top: 2px;
            opacity:.8; 
            transform: translateY(1px);
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50; 
            margin-right: 0.5rem;
        }

        .info-value {
            color: #212529;
        }

        .image-papel {
            max-width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .image-papel:hover {
            transform: scale(1.1);
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-1);
        }

        .no-results i {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .footer-section {
            background: var(--color-medical);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .table-view {
            display: none;
        }
        
        /* (Req #2) Tabla "Enterprise" */
        .table-responsive{ 
            max-height: 70vh; 
            border-radius: 10px;
            box-shadow: var(--shadow-1);
        }
        
        .table-view table {
            background: white;
            overflow: hidden;
            margin-bottom: 0; 
        }

        .table-view thead {
            background: var(--color-medical);
            color: white;
        }
        
        .table-view thead th {
            position: sticky; 
            top: 0; 
            z-index: 1;
            background: var(--color-medical); 
        }

        .table-view th {
            font-weight: 600;
            padding: var(--pad-y) var(--pad-x);
        }

        .table-view td {
            padding: var(--pad-y) var(--pad-x);
            vertical-align: middle;
        }
        
        .table tbody tr:hover{ 
            background: #f6fbff; 
        }

        /* Nueva Vista Gráfica para KPIs */
        .kpi-bars { width: 100%; }
        .kpi-bars .kpi-group { margin-bottom: 0.75rem; }
        .kpi-bars .kpi-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .kpi-bars .kpi-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        .kpi-bars .kpi-bar-label {
            width: 100px; /* Ancho fijo para alinear etiquetas */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            color: #333;
        }
        .kpi-bars .kpi-bar-track {
            flex-grow: 1;
            background: #e9ecef;
            border-radius: 4px;
            height: 18px;
            overflow: hidden;
            position: relative;
        }
        .kpi-bars .kpi-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .kpi-bars .kpi-bar-value {
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            padding: 0 0.5rem;
        }
        .kpi-bars .text-dark {
            color: #000 !important;
        }


        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 1.5rem;
            }
            
            .filter-section {
                padding: 1rem;
            }

            .btn-filter {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .results-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .card-referral {
                 margin-bottom: 1rem;
            }
            
            .kpi-bars .kpi-bar-label {
                width: 80px; /* Menos espacio en móvil */
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* (Req #2) Densidad compacta */
        .compact .card-body-custom { 
            padding: calc(var(--pad-y)*.7) calc(var(--pad-x)*.7); 
        }
        .compact .table-view td, .compact .table-view th { 
            padding: .6rem .75rem; 
        }
        .compact .info-row {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .compact .info-label {
            font-size: 0.9rem;
        }
        .compact .info-value {
            font-size: 0.9rem;
        }
        .compact .badge-custom {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        
        /* (Req #2) Accesibilidad y motion */
        :focus-visible{
          outline: 3px solid rgba(13,110,253,.35);
          outline-offset: 2px;
          border-radius: 8px;
        }
        
        @media (prefers-reduced-motion: reduce){
          *{ animation: none !important; transition: none !important; }
        }
        
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-10">
                    <h1><i class="bi bi-hospital"></i> Sistema Datos de Derivaciones </h1>
                    <p class="lead">CESFAM La Unión - Región de Los Ríos</p>
                </div>
 <div class="col-md-2 text-end d-none d-md-block">
                   <img src="2.png" alt="Logo" style="max-width: 150%; height: auto; float: left;">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Filtros -->
        <div class="filter-section fade-in">
            <div class="row g-3">
                <!-- Búsqueda General -->
                <div class="col-md-12">
                    <label for="searchGeneral" class="form-label fw-bold"><i class="bi bi-search"></i> Búsqueda General</label>
                    <input type="text" id="searchGeneral" class="form-control search-input" placeholder="Buscar por descripción, destino, tipo... (Atajo: /)">
                </div>

                <!-- Filtros por categorías -->
                <div class="col-md-3">
                    <label for="filterTipo" class="form-label fw-bold"><i class="bi bi-tags"></i> Tipo</label>
                    <select id="filterTipo" class="form-select filter-select">
                        <option value="">Todos</option>
                        <option value="Especialidad">Especialidad</option>
                        <option value="Procedimiento">Procedimiento</option>
                        <option value="Patología">Patología</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="filterVia" class="form-label fw-bold"><i class="bi bi-signpost-split"></i> Vía</label>
                    <select id="filterVia" class="form-select filter-select">
                        <option value="">Todas</option>
                        <option value="RAS">RAS</option>
                        <option value="GES">GES</option>
                        <option value="HD">HD (Hospital Digital)</option>
                        <option value="Email">Email</option>
                        <option value="Papel">Papel</option>
                        <option value="Telefónica">Telefónica</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="filterDestino" class="form-label fw-bold"><i class="bi bi-pin-map"></i> Destino</label>
                    <select id="filterDestino" class="form-select filter-select">
                        <option value="">Todos</option>
                        <!-- Opciones de destino se poblarán con JS -->
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold"><i class="bi bi-shield-check"></i> Estado GES (Atajo: g)</label>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-primary btn-filter flex-fill active" data-ges="all">Todos</button>
                        <button class="btn btn-success btn-filter flex-fill" data-ges="Si">Solo GES</button>
                        <button class="btn btn-secondary btn-filter flex-fill" data-ges="No">No GES</button>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="col-md-12">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="btnClearFilters" class="btn btn-outline-danger"><i class="bi bi-x-circle"></i> Limpiar (c)</button>
                        <button id="btnToggleView" class="btn btn-outline-primary"><i class="bi bi-grid-3x3"></i> Vista Tabla (t)</button>
                        <button id="btnExport" class="btn btn-outline-success"><i class="bi bi-download"></i> Exportar CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- (Req #3) Información de Resultados y KPIs -->
        <div class="results-info fade-in flex-wrap gap-2">
          <div>
            <strong><i class="bi bi-list-check"></i> Resultados:</strong>
            <span id="resultsCount" class="badge bg-primary ms-2">0</span>
          </div>
          <div class="ms-auto">
            <small class="text-muted">Total de registros: <span id="totalCount">0</span></small>
          </div>
          <!-- Mini Dashboard KPI + Botón Densidad -->
          <div class="w-100 pt-2 d-flex gap-2 flex-wrap align-items-center">
            <div id="miniKpis" class="d-flex gap-2 flex-wrap flex-grow-1">
                <!-- KPIs se renderán aquí -->
            </div>
            <div class="btn-group btn-group-sm ms-auto" role="group" aria-label="Controles de vista de resultados">
                <button id="btnKpiToggle" class="btn btn-outline-secondary">
                  <i class="bi bi-bar-chart-line"></i> Gráfico
                </button>
                <button id="btnDensity" class="btn btn-outline-secondary">
                  <i class="bi bi-arrows-collapse"></i> Compacta
                </button>
              </div>
          </div>
        </div>


        <!-- Vista de Cards -->
        <div id="cardsView" class="row">
            <!-- Los cards se generarán dinámicamente aquí -->
        </div>

        <!-- Vista de Tabla -->
        <div id="tableView" class="table-view">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Descripción</th>
                            <th>Vía</th>
                            <th>Destino</th>
                            <th>GES</th>
                            <th>Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Las filas se generarán dinámicamente aquí -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No hay resultados -->
        <div id="noResults" class="no-results" style="display: none;">
            <i class="bi bi-search"></i>
            <h3>No se encontraron resultados</h3>
            <p class="text-muted">Intenta ajustar los filtros de búsqueda</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-section">
        <div class="container text-center">
            <p class="mb-1"><strong>CESFAM La Unión</strong></p>Soporte Informatico </p>
            <p class="mt-2 mb-0"><small>Sistema de Derivaciones Médicas - 2025</small></p>
        </div>
    </div>

    <!-- (Req #1) Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        // (Req #5) Datos de derivaciones (Corregidos)
        const referralData = [
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Biopsia de piel y/o mucosa por curetaje o sección tangencial c/s electro x 1 lesión."
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Broncopulmonar adulto / infantil "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cardiología adulta / infantil (telemedicina) "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Cirugía Adulto "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cirugía digestiva "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Cirugía Infantil "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cirugía maxilo facial "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Cirugia Menor: Se realiza desde los 15 años y mas en CESFAM La Union"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cirugía oncológica "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cirugía proctológica "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Cirugía reparadora ungueal por proceso inflamatorio."
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Cirugía vascular "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Colonoscopía (se debe agregar Formulario de Solicitud Colonoscopia) - Sin Sospecha de Ca Colorectal - Destino \"Cirugia Proctologica\""
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Colonoscopia digestiva (Rellenar Formulario del Examen Correspondiente). Si tiene Sospecha/Cancer confirmado, envíar via GES. En caso contrario, lista de espera infinita"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Cuerpo extraño de 15 años y más. "
            },
            {
                "tipo": "Especialidad",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "No",
                "descripcion": "Dermatología (telemedicina) "
            },
            {
                "tipo": "Patología",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "No",
                "descripcion": "Diabetes Mellitus Tipo 2 - Mal compensada"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco Abdominal (edad: 0-14 años) "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Eco Abdominal (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Eco Ginecológica (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco Pared Abdominal "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco partes blandas (Idealmente, extrasistema porque no hay resolutividad actualizada)"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco renal "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco tiroidea "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Eco Transvaginal (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Eco vesical "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Ecotomografía abdominal menores de 15 años"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Ecotomografía abdominal de 15 y más"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Ecotomografía bilateral"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Endocrinología adulto / infantil "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Endoscopia Digestiva Alta (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Endoscopia digestiva alta de 0 a 14 años"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Endoscopía digestiva alta de 15 y más"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Epistaxis de 15 años y más "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Extirpación de lesión benigna subepidérmica, incluye Tumor sólido, quiste epidérmico y lipoma por lesión: Cabeza, cuello, genitales: extirpación de lesión benigna subepidérmica, incluye tumor sólido, quiste epidérmico y lipoma por lesión."
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Extirpación de lesión benigna subepidérmica, incluye Tumor sólido, quiste epidérmico y lipoma por lesión: Resto del cuerpo: extirpación de lesión benigna subepidérmica, incluye tumor sólido, quiste epidérmico y lipoma por lesión."
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Extirpación de lesiones benignas por sec tangencial, curetaje y/o fulguración hasta 15 lesiones."
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Extirpación, reparación o biopsia, total o parcial, de lesiones benignas cutáneas por excisión: Cabeza, cuello, genitales, hasta 3 lesiones."
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Extirpación, reparación o biopsia, total o parcial, de lesiones benignas cutáneas por excisión: Resto del Cuerpo hasta 3 lesiones."
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Fisiatría "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Gastroenterología adulto /infantil "
            },
            {
                "tipo": "Especialidad",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Geriatría"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Ginecología Adulto (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Hematología adulta / infantil "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Mamografía bilateral"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Mamografía unilateral"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Medicina Interna Adulto "
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Menier de 15 años y más "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Nefrología adulto /infantil "
            },
            {
                "tipo": "Especialidad",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "Si",
                "descripcion": "Nefrología Enfermedad Renal Crónica (ERC) (Adicionalmente, realizar la notificacion de papel para presentarla en oficina GES: Origen CESFAM. Destino CESFAM)"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Neurocirugía "
            },
            {
                "tipo": "Especialidad",
                "via": "Email",
                "detalle": "Referente Neurología - Dr. Olivares",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Neurología (telemedicina) "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Neurología adulto / infantil    "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Oncología "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Onicectomía total o parcial simple."
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Otitis aguda y crónica de 15 años y más "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Otorrino "
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Patología mamaria "
            },
            {
                "tipo": "Patología",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "No",
                "descripcion": "Patología Oral"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Pediatría Secundaria "
            },
            {
                "tipo": "Procedimiento",
                "via": "Telefónica",
                "detalle": "Oficina Lista de Espera",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Proyección Focalizada",
                "imagen": "https://placehold.co/80x80/6c757d/ffffff?text=Tel%C3%A9fono"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Psiquiatría adulto / infantil  "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Radiología (No se ingresan TAC)"
            },
            {
                "tipo": "Procedimiento",
                "via": "Papel",
                "detalle": "Orden de Examen",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Radiología columna lumbar ap/lat/5° Espacio ",
                "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
            },
            {
                "tipo": "Especialidad",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "No",
                "descripcion": "Reumatología "
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Sospecha Hipoacusia de 15 a 64 años (Una vez resuelto ese tramo etario se puede resolver de 5 a 14 años de edad (Siempre coordinado con Leonor Villavicencio, referente del programa) "
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "Oficina GES",
                "destino": "Variable",
                "ges": "Si",
                "descripcion": "Sospecha Hipoacusia mayores de 65 años (y todos los otros diagnósticos y tramos de edades que no se resuelven en APS)"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Tapón de cerumen de 15 años y más "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Test Esfuerzo (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Patología",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "No",
                "descripcion": "Traumatismo Temporomandibular (TTM)"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Traumatología Adulto (Edad: 15 Años Y Mas) "
            },
            {
                "tipo": "Especialidad",
                "via": "Papel",
                "detalle": "SIC Papel",
                "destino": "Oficina Lista de Espera",
                "ges": "No",
                "descripcion": "Traumatología derivado desde Urgencia SAR (Adulto y Niño)",
                "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Traumatología infantil "
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Tumores vasculares profundos Cara, cuero cabelludo, cuello, genitales."
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "LEC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Tumores Vasculares Profundos Resto del cuerpo."
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Oftalmologia: Usuarios de 15 a 64 años con Diagnostico de Vicio Refracción. La derivación es por RAS a unidad UAPO La Union."
            },
            {
                "tipo": "Especialidad",
                "via": "GES",
                "detalle": "Oficina GES",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Oftalmologia: Usuarios Mayores de 64 años: Realizar la notificacion de papel para presentarla en oficina GES: Origen CESFAM. Destino HBV)"
            },
            {
                "tipo": "Especialidad",
                "via": "Papel",
                "detalle": "SIC Papel",
                "destino": "JUNAEB",
                "ges": "No",
                "descripcion": "Oftalmologia: UAPO Menores de 15 años: a JUNAEB vía papel que debe presentar el mismo usuario",
                "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Urología Adulto"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Vértigo de 15 años y más "
            },
            {
                "tipo": "Patología",
                "via": "HD",
                "detalle": "Telemedicina",
                "destino": "Hospital Digital",
                "ges": "Si",
                "descripcion": "Enfermedad Renal Crónica (ERC) (Adicionalmente, realizar SIC de papel Dx: \"Prevencion Secundaria de ERC\" que se presenta en oficina GES: con Origen CESFAM Destino CESFAM) - HD Nefrologia"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Adenoides"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "",
                "ges": "Si",
                "descripcion": "Fondo de Ojo para Usuarios con Diabetes Mellitus Tipo 2 (Se llama: Control Paciente DM Tipo 2 Nivel Secundario, pero permite acceso a \"Fondo de Ojo\")"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Artritis Reumatoide (Confirmacion Diagnostica)",
                "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "GES",
                "destino": "Oficina GES",
                "ges": "Si",
                "descripcion": "Artrosis - Leve a Moderada (CESFAM) (Dx: \"Tratamiento médico en personas de 55 años y más con artrosis de cadera y/o rodilla, leve o moderada\")"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "GES",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Artrosis - Severa de Rodilla (Destino Reumatologia)"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "GES",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Artrosis - Severa de Cadera (Destino Traumatologia)"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "Telemedicina",
                "destino": "",
                "ges": "",
                "descripcion": "Hipertension descompensada (Medicina interna o cardiologia)"
            },
            {
                "tipo": "Especialidad",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "",
                "descripcion": "Neurologia: depende de la patologia"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "Telemedicina",
                "destino": "",
                "ges": "",
                "descripcion": "Cefalea"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "telemedicina",
                "destino": "",
                "ges": "No",
                "descripcion": "Epilepsia (ya diagnosticado)"
            },
            {
                "tipo": "Patología",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "Si",
                "descripcion": "Epilepsia (sospecha) - Averiguar"
            },
            {
                "tipo": "Patología",
                "via": "Papel",
                "detalle": "SIC Papel",
                "destino": "",
                "ges": "Si",
                "descripcion": "Demencia",
                "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "Telemedicina",
                "destino": "",
                "ges": "No",
                "descripcion": "Cardiologia"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital La Union",
                "ges": "Si",
                "descripcion": "Colelitiasis (confirmado \"notificar\" Derivacion con examenes tomados, revisados y compensados IMC <40)",
                "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Vicios de refracción en personas mayores de 65 años y mas "
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Asma Bronquial 15 años y mas "
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Asma Bronquial moderada y severa en menores de 15 años "
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "Notificacion+receta",
                "destino": "CESFAM",
                "ges": "Si",
                "descripcion": "Ayudas Tecnicas para personas de 65 años y mas "
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "Receta papel",
                "destino": "CESFAM",
                "ges": "Si",
                "descripcion": "Ayudas Tecnicas Pilotos de 46 años a 64 años( siguientes dignosticos: acv severo, acv moderado, acv leve, artrosis de rodilla, amputaciones ortejo y metatardo, postrados(severos) Parkinson y Lesion Medular)"
            },
            {
                "tipo": "Patología",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Cancer Colorectal en personas de 15 años y mas (formulario de solicitud colonosocpia)",
                "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
            },
            {
                "tipo": "Procedimiento",
                "via": "GES",
                "detalle": "SIC Papel",
                "destino": "Hospital Base Valdivia",
                "ges": "Si",
                "descripcion": "Colonoscopía (se debe agregar Formulario de Solicitud Colonoscopia) - Con Sospecha de Ca Colorectal - Destino \"Gastroenterologia\"",
                "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Enfermedad Celiaca Infantil (Destino Pediatria Secundaria)"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital Base Valdivia",
                "ges": "No",
                "descripcion": "Enfermedad Celiaca Adulto (Mayores a 15 años) (Destino Gastroenterologia Adulto)"
            },
            {
                "tipo": "Especialidad",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "",
                "descripcion": "UNACESS: depende de la patologia - usar Guia de derivacion desde APS a UNACESS (Presione Aqui para Acceder a la Guia)"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Parkinson (Sospecha)"
            },
            {
                "tipo": "Procedimiento",
                "via": "RAS",
                "detalle": "OA",
                "destino": "CESFAM La Unión",
                "ges": "No",
                "descripcion": "Ecotomografía mamaria bilateral"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "Telemedicina",
                "destino": "Hospital Rio Bueno",
                "ges": "No",
                "descripcion": "OPI (Destino Odontopediatria)"
            },
            {
                "tipo": "Patología",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Alergia a la Proteina de la Vaca (APV)"
            },
            {
                "tipo": "Especialidad",
                "via": "RAS",
                "detalle": "IC",
                "destino": "Hospital La Union",
                "ges": "No",
                "descripcion": "Cardiología Adulto"
            },
            {
                "tipo": "Patología",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "Si",
                "descripcion": "Glaucoma"
            },
            {
                "tipo": "Patología",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "No",
                "descripcion": "Helicobacter Pylori (15 años y más)"
            },
            {
                "tipo": "Procedimiento",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "No",
                "descripcion": "Test de Antigeno en Deposiciones Helicobacter Pylori (modalidad institucional)"
            },
            {
                "tipo": "Patología",
                "via": "",
                "detalle": "",
                "destino": "",
                "ges": "Si",
                "descripcion": "Alzheimer y otras Demencias (GES 85)"
            }
        ];

        // (Req #4) Mapa de color por tipo (para la banda superior de la card)
        const tipoColorMap = {
          'Especialidad': '#6b7cff',
          'Procedimiento': '#13b1a8',
          'Patología': '#f06784',
          'Patologia': '#f06784' // Alias sin tilde
        };
        
        // (Req #1) Utilidades de búsqueda
        // Normaliza para búsqueda/compare (sin tildes, lower, trim)
        const norm = (v) => String(v ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
        // Debounce simple
        const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

        // Variables globales
        let filteredData = [...referralData];
        let currentGesFilter = 'all';
        let isTableView = false;
        let isKpiBarView = false; // Estado para la vista del dashboard (píldoras/gráfico)

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            renderResults();
            setupEventListeners();
        });

        // (Req #3) Filtros limpios y ordenados
        function initializeFilters() {
          // Poblar destinos únicos (trim + sin tildes para ordenar, pero mostrando original)
          const destinoSelect = document.getElementById('filterDestino');
          const uniq = new Map();
          referralData.forEach(it => {
            const raw = (it.destino ?? '').trim();
            if (!raw) return;
            const key = norm(raw);
            if (!uniq.has(key)) uniq.set(key, raw);
          });
          [...uniq.values()].sort((a,b)=> a.localeCompare(b, 'es')).forEach(dest => {
            const opt = document.createElement('option');
            opt.value = dest;
            opt.textContent = dest;
            destinoSelect.appendChild(opt);
          });

          // Total
          document.getElementById('totalCount').textContent = referralData.length;
        }


        // Configurar event listeners
        function setupEventListeners() {
            // (Req #1) Búsqueda general (con debounce)
            document.getElementById('searchGeneral').addEventListener('input', debounce(applyFilters, 180));
            
            // Filtros de selección
            document.getElementById('filterTipo').addEventListener('change', applyFilters);
            document.getElementById('filterVia').addEventListener('change', applyFilters);
            document.getElementById('filterDestino').addEventListener('change', applyFilters);
            
            // Botones GES
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentGesFilter = this.getAttribute('data-ges');
                    applyFilters();
                });
            });
            
            // Limpiar filtros
            document.getElementById('btnClearFilters').addEventListener('click', clearFilters);
            
            // Toggle vista
            document.getElementById('btnToggleView').addEventListener('click', toggleView);
            
            // Exportar CSV
            document.getElementById('btnExport').addEventListener('click', exportToCSV);
            
            // Toggle densidad
            document.getElementById('btnDensity')?.addEventListener('click', (e)=>{
              document.body.classList.toggle('compact');
              // Feedback en el botón
              const btn = e.currentTarget;
                if (document.body.classList.contains('compact')) {
                    btn.innerHTML = '<i class="bi bi-arrows-expand"></i> Normal';
                } else {
                    btn.innerHTML = '<i class="bi bi-arrows-collapse"></i> Compacta';
                }
            });
            
            // Toggle vista KPI (Píldoras/Gráfico)
            document.getElementById('btnKpiToggle')?.addEventListener('click', (e) => {
                isKpiBarView = !isKpiBarView;
                const btn = e.currentTarget;
                if (isKpiBarView) {
                    btn.innerHTML = '<i class="bi bi-tags-fill"></i> Píldoras';
                    btn.classList.add('active');
                } else {
                    btn.innerHTML = '<i class="bi bi-bar-chart-line"></i> Gráfico';
                    btn.classList.remove('active');
                }
                renderMiniKpis(); // Re-render solo los KPIs
            });
            
            // (Req #5) Atajos de teclado
            document.addEventListener('keydown', (e)=>{
              // No activar si estamos escribiendo en un input
              if (e.target.matches('input,select,textarea')) return;
              
              const k = e.key.toLowerCase();
              
              if (k === '/') { 
                  e.preventDefault(); 
                  document.getElementById('searchGeneral').focus(); 
              }
              if (k === 't') { 
                  e.preventDefault(); 
                  toggleView(); 
              }
              if (k === 'c') { 
                  e.preventDefault(); 
                  clearFilters(); 
              }
              if (k === 'g') { 
                e.preventDefault();
                const order = ['all','Si','No'];
                const idx = order.indexOf(currentGesFilter);
                currentGesFilter = order[(idx+1)%order.length];
                // Sincroniza botones
                document.querySelectorAll('.btn-filter').forEach(b=>{
                  b.classList.toggle('active', b.getAttribute('data-ges')===currentGesFilter);
                });
                applyFilters();
              }
            });
        }

        // (Req #2) Filtros y búsqueda robustos
        function applyFilters() {
          const searchText = norm(document.getElementById('searchGeneral').value);
          const filterTipo    = norm(document.getElementById('filterTipo').value);
          const filterVia     = norm(document.getElementById('filterVia').value);
          const filterDestino = norm(document.getElementById('filterDestino').value);

          filteredData = referralData.filter(item => {
            // Texto libre: inspecciona solo strings útiles
            const hayBusqueda = searchText.length > 0;
            const matchesSearch = !hayBusqueda || [
              'tipo','via','detalle','destino','ges','descripcion'
            ].some(k => norm(item[k]).includes(searchText));

            // Selects tolerantes (sin tildes/caso/espacios)
            const matchesTipo    = !filterTipo    || norm(item.tipo)    === filterTipo;
            const matchesVia     = !filterVia     || norm(item.via)     === filterVia;
            const matchesDestino = !filterDestino || norm(item.destino) === filterDestino;

            // Botonera GES
            const g = norm(item.ges);
            const matchesGes = (currentGesFilter === 'all') ||
                               (currentGesFilter === 'Si' && (g === 'si' || g === 'sí')) ||
                               (currentGesFilter === 'No' && (g === 'no' || g === '' || g === 'null'));

            return matchesSearch && matchesTipo && matchesVia && matchesDestino && matchesGes;
          });

          renderResults();
        }


        // Renderizar resultados
        function renderResults() {
            document.getElementById('resultsCount').textContent = filteredData.length;

            if (filteredData.length === 0) {
                document.getElementById('cardsView').innerHTML = '';
                document.getElementById('tableBody').innerHTML = '';
                document.getElementById('noResults').style.display = 'block';
            } else {
                document.getElementById('noResults').style.display = 'none';
            }

            if (isTableView) {
                renderTableView();
            } else {
                renderCardsView();
            }
            
            // (Req #4) Render KPI Bar
            renderMiniKpis();
        }

        // Renderizar vista de cards
        function renderCardsView() {
            const container = document.getElementById('cardsView');
            container.innerHTML = '';

            filteredData.forEach((item, index) => {
                const card = createCard(item, index);
                container.appendChild(card);
            });
        }

        // Crear card individual
        function createCard(item, index) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 d-flex align-items-stretch fade-in';
            
            const tipoBadgeClass = getTipoBadgeClass(item.tipo);
            const ges = String(item.ges).toLowerCase();
            const isGes = ges === 'si' || ges === 'sí';
            const gesBadgeClass = isGes ? 'badge-ges-si' : 'badge-ges-no';
            const gesText = isGes ? 'GES' : 'No GES';

            // (Req #4) Inyecta el color en línea para la banda superior
            col.innerHTML = `
                <div class="card card-referral w-100" style="--tipo-color:${tipoColorMap[item.tipo] || 'var(--color-medical)'}">
                    <div class="card-header-custom">
                        <span class="badge badge-custom ${tipoBadgeClass}">${item.tipo || 'N/A'}</span>
                        <span class="badge badge-custom ${gesBadgeClass}">${gesText}</span>
                    </div>
                    <div class="card-body-custom">
                        <div class="info-container">
                            <div class="info-row">
                                <i class="bi bi-file-text"></i>
                                <div>
                                    <span class="info-label">Descripción:</span>
                                    <!-- (Req #6) Trim de la descripción -->
                                    <div class="info-value">${(item.descripcion || 'N/A').trim()}</div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <i class="bi bi-arrow-right-circle"></i>
                                <div>
                                    <span class="info-label">Vía:</span>
                                    <span class="info-value">${item.via || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <i class="bi bi-info-circle"></i>
                                <div>
                                    <span class="info-label">Detalle:</span>
                                    <span class="info-value">${item.detalle || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <i class="bi bi-geo-alt"></i>
                                <div>
                                    <span class="info-label">Destino:</span>
                                    <span class="info-value">${item.destino || 'N/A'}</span>
                                </div>
                            </div>
                            
                            ${item.imagen ? `
                            <div class="info-row">
                                <i class="bi bi-image"></i>
                                <div>
                                    <span class="info-label">Documento:</span>
                                    <br>
                                    <img src="${item.imagen}" alt="Documento" class="image-papel mt-2" onerror="this.src='https://placehold.co/80x80/6c757d/ffffff?text=Error'">
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard(event, ${index})">
                                <i class="bi bi-clipboard"></i> Copiar Info
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // Renderizar vista de tabla
        function renderTableView() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach((item, index) => {
                const row = createTableRow(item, index);
                tbody.appendChild(row);
            });
        }

        // Crear fila de tabla
        function createTableRow(item, index) {
            const tr = document.createElement('tr');
            tr.className = 'fade-in';
            
            const tipoBadgeClass = getTipoBadgeClass(item.tipo);
            const ges = String(item.ges).toLowerCase();
            const isGes = ges === 'si' || ges === 'sí';
            const gesBadgeClass = isGes ? 'badge-ges-si' : 'badge-ges-no';
            const gesText = isGes ? 'GES' : 'No GES';

            tr.innerHTML = `
                <td><span class="badge badge-custom ${tipoBadgeClass}">${item.tipo || 'N/A'}</span></td>
                <td>${(item.descripcion || 'N/A').trim()}</td>
                <td>${item.via || 'N/A'}</td>
                <td>${item.destino || 'N/A'}</td>
                <td><span class="badge badge-custom ${gesBadgeClass}">${gesText}</span></td>
                <td>${item.detalle || 'N/A'}</td>
            `;
            return tr;
        }

        // --- FUNCIONES AUXILIARES ---
        
        // (Req #4 + Gráfico) KPI Bar con dos vistas
        function renderMiniKpis(){
          const kpiContainer = document.getElementById('miniKpis');
          
          if (filteredData.length === 0) {
              kpiContainer.innerHTML = '<span class="text-muted small">Sin agrupaciones para mostrar</span>';
              kpiContainer.className = 'd-flex gap-2 flex-wrap flex-grow-1';
              return;
          }

          const group = (key)=> filteredData.reduce((acc,it)=>{
            const k = (String(it[key] ?? '').trim() === '') ? 'N/A' : (it[key] ?? 'N/A');
            acc[k] = (acc[k]||0)+1; return acc;
          },{});
          
          const tipo = group('tipo');
          const via  = group('via');
          const ges  = filteredData.reduce((a,it)=>{
            const g = norm(it.ges);
            const bucket = (g === 'si' || g === 'sí') ? 'GES' : (g === 'no' || g === '' || g === 'null') ? 'No GES' : 'N/A';
            a[bucket] = (a[bucket]||0)+1; return a;
          }, {});

          // --- Lógica de Vistas ---
          
          if (isKpiBarView) {
            // VISTA DE GRÁFICO
            kpiContainer.className = 'kpi-bars flex-grow-1'; // Usar estilos de barra
            
            const createBarGroup = (title, data, colorFn) => {
                const total = Object.values(data).reduce((s, c) => s + c, 0);
                if (total === 0) return '';
                
                const maxVal = Math.max(1, ...Object.values(data)); // Evitar div por cero
                
                return `
                    <div class="kpi-group">
                        <div class="kpi-group-title">${title} (${total})</div>
                        ${Object.entries(data).sort((a,b)=>b[1]-a[1]).map(([k,n]) => {
                            const [cls, textCls] = colorFn(k);
                            const perc = (n / maxVal) * 100;
                            return `
                            <div class="kpi-bar-item" title="${k}: ${n}">
                                <div class="kpi-bar-label">${k}</div>
                                <div class="kpi-bar-track">
                                    <div class="kpi-bar-fill ${cls}" style="width: ${perc}%;">
                                        <span class="kpi-bar-value ${textCls}">${n}</span>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
            };
            
            const tipoColorFn = (k) => [getTipoBadgeClass(k), (k === 'Procedimiento' ? 'text-dark' : 'text-white')]; // Procedimiento es claro
            const viaColorFn  = (k) => ['bg-info', 'text-dark'];
            const gesColorFn  = (k) => {
                if (k === 'GES') return ['badge-ges-si', 'text-dark'];
                if (k === 'No GES') return ['badge-ges-no', 'text-white'];
                return ['bg-secondary', 'text-white'];
            };

            kpiContainer.innerHTML = `
                ${createBarGroup('Por Tipo', tipo, tipoColorFn)}
                ${createBarGroup('Por Vía', via, viaColorFn)}
                ${createBarGroup('Por GES', ges, gesColorFn)}
            `;

          } else {
            // VISTA DE PÍLDORAS (Req #4)
            kpiContainer.className = 'd-flex gap-2 flex-wrap flex-grow-1'; // Estilos por defecto
            
            const textClsForBadge = (cls) => {
              return (cls.includes('bg-info') || cls.includes('badge-ges-si') || cls.includes('badge-tipo-procedimiento')) ? 'text-dark' : 'text-white';
            }
            
            const pill = (txt,n,cls, extra='')=> `<span class="badge ${cls} ${extra} rounded-pill px-3 py-2" style="font-size:.75rem;">${txt}: <strong>${n}</strong></span>`;
            
            const html = [
              ...Object.entries(tipo).sort((a,b)=>b[1]-a[1]).map(([k,n])=>{
                  const cls = getTipoBadgeClass(k);
                  return pill(k,n,cls, textClsForBadge(cls));
              }),
              ...Object.entries(via ).sort((a,b)=>b[1]-a[1]).map(([k,n])=>pill(k,n,'bg-info','text-dark')),
              ...Object.entries(ges ).sort((a,b)=>b[1]-a[1]).map(([k,n])=>{
                  const cls = (k==='GES' ? 'badge-ges-si' : (k==='No GES'?'badge-ges-no':'bg-secondary'));
                  return pill(k, n, cls, textClsForBadge(cls));
              })
            ].join(' ');
            
            kpiContainer.innerHTML = html;
          }
        }


        // Obtener clase de badge por tipo
        function getTipoBadgeClass(tipo) {
            if (!tipo) return 'bg-secondary';
            switch (String(tipo).toLowerCase()) {
                case 'especialidad':
                    return 'badge-tipo-especialidad';
                case 'procedimiento':
                    return 'badge-tipo-procedimiento';
                case 'patología':
                case 'patologia': // Contempla la falta de tilde
                    return 'badge-tipo-patologia';
                default:
                    return 'bg-dark';
            }
        }

        // Copiar al portapapeles
        window.copyToClipboard = function(event, index) {
            const item = filteredData[index];
            const textToCopy = [
                `Derivación: ${(item.descripcion || 'N/A').trim()}`,
                `Tipo: ${item.tipo || 'N/A'}`,
                `Vía: ${item.via || 'N/A'}`,
                `Destino: ${item.destino || 'N/A'}`,
                `Detalle: ${item.detalle || 'N/A'}`,
                `GES: ${item.ges || 'N/A'}`
            ].join('\n');

            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.top = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            let copySuccess = false;
            try {
                copySuccess = document.execCommand('copy');
            } catch (err) {
                console.error('Error al copiar:', err);
            }
            document.body.removeChild(textarea);

            // Retroalimentación visual en el botón
            if (event && event.target && copySuccess) {
                const btn = event.target.closest('button');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check-lg"></i> Copiado';
                    btn.disabled = true;
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline-primary');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    }, 2000);
                }
            }
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('searchGeneral').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterVia').value = '';
            document.getElementById('filterDestino').value = '';

            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-ges') === 'all') {
                    btn.classList.add('active');
                }
            });
            currentGesFilter = 'all';
            
            // Reset density
            document.body.classList.remove('compact');
            document.getElementById('btnDensity').innerHTML = '<i class="bi bi-arrows-collapse"></i> Compacta';
            
            // Reset KPI view
            isKpiBarView = false;
            const kpiBtn = document.getElementById('btnKpiToggle');
            kpiBtn.innerHTML = '<i class="bi bi-bar-chart-line"></i> Gráfico';
            kpiBtn.classList.remove('active');


            applyFilters();
        }

        // Cambiar vista
        function toggleView() {
            isTableView = !isTableView;
            
            const btn = document.getElementById('btnToggleView');
            const cardsView = document.getElementById('cardsView');
            const tableView = document.getElementById('tableView');

            if (isTableView) {
                cardsView.style.display = 'none';
                tableView.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-card-list"></i> Vista Cards (t)';
            } else {
                cardsView.style.display = ''; 
                tableView.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-grid-3x3"></i> Vista Tabla (t)';
            }
            
            renderResults();
        }

        // Sanitizar valor para CSV
        function sanitizeCSV(value) {
            if (value == null) return '';
            let str = String(value);
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        }

        // Exportar a CSV
        function exportToCSV() {
            const headers = ["Tipo", "Descripcion", "Via", "Destino", "GES", "Detalle"];
            let csvContent = headers.join(',') + '\n';

            filteredData.forEach(item => {
                const row = [
                    sanitizeCSV(item.tipo),
                    sanitizeCSV(item.descripcion),
                    sanitizeCSV(item.via),
                    sanitizeCSV(item.destino),
                    sanitizeCSV(item.ges),
                    sanitizeCSV(item.detalle)
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para UTF-8
            const link = document.createElement('a');
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'derivaciones_cesfam_la_union.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

    </script>
</body>
</html>

   
