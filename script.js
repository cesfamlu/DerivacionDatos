// (Req #5) Datos de derivaciones (Corregidos)
const referralData =[
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Biopsia de piel y/o mucosa por curetaje o sección tangencial c/s electro x 1 lesión."
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Broncopulmonar adulto / infantil "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cardiología adulta / infantil (telemedicina) "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Cirugía Adulto "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cirugía digestiva "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Cirugía Infantil "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cirugía maxilo facial "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Cirugia Menor: Se realiza desde los 15 años y mas en CESFAM La Union"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cirugía oncológica "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cirugía proctológica "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Cirugía reparadora ungueal por proceso inflamatorio."
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Cirugía vascular "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Colonoscopía (se debe agregar Formulario de Solicitud Colonoscopia) - Sin Sospecha de Ca Colorectal - Destino \"Cirugia Proctologica\""
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Colonoscopia digestiva (Rellenar Formulario del Examen Correspondiente). Si tiene Sospecha/Cancer confirmado, envíar via GES. En caso contrario, lista de espera infinita"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Cuerpo extraño de 15 años y más. "
},
{
 "tipo": "Especialidad",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "No",
 "descripcion": "Dermatología (telemedicina) "
},
{
 "tipo": "Patología",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "No",
 "descripcion": "Diabetes Mellitus Tipo 2 - Mal compensada"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco Abdominal (edad: 0-14 años) "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Eco Abdominal (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Eco Ginecológica (Edad: 15 Años Y Mas) "
},

 {
    "tipo": "Especialidad",
    "via": "Correo Electronico",
    "detalle": "cesfam.neurodiversa@munilaunion.cl",
    "destino": "Centro Atencion Integracion al Desarrollo Infantoadolescente (CAIDIA)",
    "ges": "No",
    "descripcion": "Usuario evaluado en CNS o Control Adolescente, referido via correo electronico, contraloría por Referente Fonoaudióloga Foitzick"
  },
 
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco Pared Abdominal "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco partes blandas (Idealmente, extrasistema porque no hay resolutividad actualizada)"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco renal "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco tiroidea "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Eco Transvaginal (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Eco vesical "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Ecotomografía bilateral"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Endocrinología adulto / infantil "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Endoscopia Digestiva Alta (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Endoscopia digestiva alta de 0 a 14 años"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Endoscopía digestiva alta de 15 y más"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Epistaxis de 15 años y más "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Extirpación de lesión benigna subepidérmica, incluye Tumor sólido, quiste epidérmico y lipoma por lesión: Cabeza, cuello, genitales: extirpación de lesión benigna subepidérmica, incluye tumor sólido, quiste epidérmico y lipoma por lesión."
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Extirpación de lesión benigna subepidérmica, incluye Tumor sólido, quiste epidérmico y lipoma por lesión: Resto del cuerpo: extirpación de lesión benigna subepidérmica, incluye tumor sólido, quiste epidérmico y lipoma por lesión."
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Extirpación de lesiones benignas por sec tangencial, curetaje y/o fulguración hasta 15 lesiones."
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Extirpación, reparación o biopsia, total o parcial, de lesiones benignas cutáneas por excisión: Cabeza, cuello, genitales, hasta 3 lesiones."
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Extirpación, reparación o biopsia, total o parcial, de lesiones benignas cutáneas por excisión: Resto del Cuerpo hasta 3 lesiones."
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Fisiatría "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Gastroenterología adulto /infantil "
},
{
 "tipo": "Especialidad",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Geriatría"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Ginecología Adulto (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Hematología adulta / infantil "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Mamografía bilateral"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Mamografía unilateral"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Medicina Interna Adulto "
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Menier de 15 años y más "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Nefrología adulto /infantil "
},
{
 "tipo": "Especialidad",
 "via": "HD",
 "detalle": "Telemedicina ",
 "destino": "Hospital Digital",
 "ges": "Si",
 "descripcion": "Nefrología Enfermedad Renal Crónica (ERC) (Adicionalmente, realizar la notificacion de papel para presentarla en oficina GES: Origen CESFAM. Destino CESFAM)"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Neurocirugía "
},
{
 "tipo": "Especialidad",
 "via": "Email",
 "detalle": "Referente Neurología - Dr. Olivares",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Neurología (telemedicina) "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Neurología adulto / infantil   "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Oncología "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Onicectomía total o parcial simple."
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Otitis aguda y crónica de 15 años y más "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Otorrino "
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Patología mamaria "
},
{
 "tipo": "Patología",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "No",
 "descripcion": "Patología Oral"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Pediatría Secundaria "
},
{
 "tipo": "Procedimiento",
 "via": "Telefónica",
 "detalle": "Oficina Lista de Espera",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Proyección Focalizada",
 "imagen": "https://placehold.co/80x80/6c757d/ffffff?text=Tel%C3%A9fono"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Psiquiatría adulto / infantil  "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Radiología (No se ingresan TAC)"
},
{
 "tipo": "Procedimiento",
 "via": "Papel",
 "detalle": "Orden de Examen",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Radiología columna lumbar ap/lat/5° Espacio ",
 "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
},
{
 "tipo": "Especialidad",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "No",
 "descripcion": "Reumatología "
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Valdivia",
 "ges": "No",
 "descripcion": "Sospecha Hipoacusia de 15 a 64 años (Una vez resuelto ese tramo etario se puede resolver de 5 a 14 años de edad (Siempre coordinado con Leonor Villavicencio, referente del programa) "
},
{
 "tipo": "Patología",
 "via": "Lista de Espera",
 "detalle": "Oficina GES gestionará la hora",
 "destino": "Hospital Valdivia",
 "ges": "Si",
 "descripcion": "Sospecha Hipoacusia mayores de 65 años (y todos los otros diagnósticos y tramos de edades que no se resuelven en APS)"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Tapón de cerumen de 15 años y más "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Test Esfuerzo (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Patología",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "No",
 "descripcion": "Traumatismo Temporomandibular (TTM)"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Traumatología Adulto (Edad: 15 Años Y Mas) "
},
{
 "tipo": "Especialidad",
 "via": "Papel",
 "detalle": "SIC Papel",
 "destino": "Oficina Lista de Espera",
 "ges": "No",
 "descripcion": "Traumatología derivado desde Urgencia SAR (Adulto y Niño)",
 "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Traumatología infantil "
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Tumores vasculares profundos Cara, cuero cabelludo, cuello, genitales."
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "LEC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Tumores Vasculares Profundos Resto del cuerpo."
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Union",
 "ges": "No",
 "descripcion": "Oftalmologia: Usuarios de 15 a 64 años con Diagnostico de Vicio Refracción. La derivación es por RAS a unidad UAPO La Union."
},
{
 "tipo": "Especialidad",
 "via": "GES",
 "detalle": "Oficina GES",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Oftalmologia: Usuarios Mayores de 64 años: Realizar la notificacion de papel para presentarla en oficina GES: Origen CESFAM. Destino HBV)"
},
{
 "tipo": "Especialidad",
 "via": "Papel",
 "detalle": "SIC Papel",
 "destino": "JUNAEB",
 "ges": "No",
 "descripcion": "Oftalmologia: UAPO Menores de 15 años: a JUNAEB vía papel que debe presentar el mismo usuario",
 "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Urología Adulto"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Vértigo de 15 años y más "
},
{
 "tipo": "Patología",
 "via": "HD",
 "detalle": "Telemedicina",
 "destino": "Hospital Digital",
 "ges": "Si",
 "descripcion": "Enfermedad Renal Crónica (ERC) (Adicionalmente, realizar SIC de papel Dx: \"Prevencion Secundaria de ERC\" que se presenta en oficina GES: con Origen CESFAM Destino CESFAM) - HD Nefrologia"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Adenoides"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "CESFAM La Union",
 "ges": "Si",
 "descripcion": "Fondo de Ojo para Usuarios con Diabetes Mellitus Tipo 2 (Se llama: Control Paciente DM Tipo 2 Nivel Secundario, pero permite acceso a \"Fondo de Ojo\")"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Artritis Reumatoide (Confirmacion Diagnostica)",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "GES",
 "destino": "Oficina GES",
 "ges": "No",
 "descripcion": "Artrosis - Leve a Moderada (CESFAM) (Dx: \"Tratamiento médico en personas de 55 años y más con artrosis de cadera y/o rodilla, leve o moderada\")"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "GES",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Artrosis - Severa de Rodilla (Destino Reumatologia)"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "GES",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Artrosis - Severa de Cadera (Destino Traumatologia)"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "Telemedicina",
 "destino": "",
 "ges": "",
 "descripcion": "Hipertension descompensada (Medicina interna o cardiologia)"
},
{
 "tipo": "Especialidad",
 "via": "",
 "detalle": "",
 "destino": "",
 "ges": "",
 "descripcion": "Neurologia: depende de la patologia"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "Telemedicina",
 "destino": "",
 "ges": "",
 "descripcion": "Cefalea"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "telemedicina",
 "destino": "",
 "ges": "No",
 "descripcion": "Epilepsia (ya diagnosticado)"
},
{
 "tipo": "Patología",
 "via": "",
 "detalle": "",
 "destino": "",
 "ges": "Si",
 "descripcion": "Epilepsia (sospecha) - Averiguar"
},
{
 "tipo": "Patología",
 "via": "Papel",
 "detalle": "SIC Papel",
 "destino": "",
 "ges": "Si",
 "descripcion": "Demencia",
 "imagen": "https://placehold.co/80x80/dc3545/ffffff?text=Papel"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "Telemedicina",
 "destino": "",
 "ges": "No",
 "descripcion": "Cardiologia"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital La Union",
 "ges": "Si",
 "descripcion": "Colelitiasis Diagnostico Sólo por Observacion edad: mayor a 35 y menor a 50 años ",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},


{
 "tipo": "procedimiento ",
 "via": "GES",
 "detalle": "GES",
 "destino": "",
 "ges": "Si",
 "descripcion": "Eco Abdominal"
},


        
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Vicios de refracción en personas mayor o igual a 65 años "
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "Notificar GES Asma -> Luego proceder con la SIC",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Asma Bronquial 15 años y mas "
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "Notificar GES Asma -> Luego proceder con la SIC",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Asma Bronquial moderada y severa en menores de 15 años "
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "Notificacion+receta",
 "destino": "CESFAM",
 "ges": "Si",
 "descripcion": "Ayudas Tecnicas para personas de 65 años y mas "
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "Notificar GES Asma -> Luego proceder con la SIC",
 "destino": "CESFAM",
 "ges": "No",
 "descripcion": "Ayudas Tecnicas Pilotos de 46 años a 64 años( siguientes dignosticos: acv severo, acv moderado, acv leve, artrosis de rodilla, amputaciones ortejo y metatardo, postrados(severos) Parkinson y Lesion Medular)"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia - Gastroentereologo",
 "ges": "Si",
 "descripcion": "Cancer Colorectal en personas de 15 años y mas (formulario de solicitud colonosocpia)",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Procedimiento",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Colonoscopía (se debe agregar Formulario de Solicitud Colonoscopia) - Con Sospecha de Ca Colorectal - Destino \"Gastroenterologia\"",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Enfermedad Celiaca Infantil (Destino Pediatria Secundaria)"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital Base Valdivia",
 "ges": "No",
 "descripcion": "Enfermedad Celiaca Adulto (Mayores a 15 años) (Destino Gastroenterologia Adulto)"
},
{
 "tipo": "Especialidad",
 "via": "",
 "detalle": "",
 "destino": "",
 "ges": "",
 "descripcion": "UNACESS: depende de la patologia - usar Guia de derivacion desde APS a UNACESS (Presione Aqui para Acceder a la Guia)"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Parkinson (Sospecha)"
},
{
 "tipo": "Procedimiento",
 "via": "RAS",
 "detalle": "OA",
 "destino": "CESFAM La Unión",
 "ges": "No",
 "descripcion": "Ecotomografía mamaria bilateral"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "Telemedicina",
 "destino": "Hospital Rio Bueno",
 "ges": "No",
 "descripcion": "OPI (Destino Odontopediatria)"
},
{
 "tipo": "Patología",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Alergia a la Proteina de la Vaca (APV)"
},
{
 "tipo": "Especialidad",
 "via": "RAS",
 "detalle": "IC",
 "destino": "Hospital La Union",
 "ges": "No",
 "descripcion": "Cardiología Adulto"
},
{
 "tipo": "Patología",
 "via": "SIC",
 "detalle": "",
 "destino": "",
 "ges": "No",
 "descripcion": "Glaucoma"
},
{
 "tipo": "Patología",
 "via": "",
 "detalle": "",
 "destino": "",
 "ges": "No",
 "descripcion": "Helicobacter Pylori (15 años y más)"
},
{
 "tipo": "Procedimiento",
 "via": "",
 "detalle": "",
 "destino": "",
 "ges": "No",
 "descripcion": "Test de Antigeno en Deposiciones Helicobacter Pylori (modalidad institucional)"
},
{
 "tipo": "Patología",
 "via": "",
 "detalle": "Formualrio Notifiacion por sospecha o confirmación",
 "destino": "Oficina GES",
 "ges": "Si",
 "descripcion": "Alzheimer y otras Demencias (GES 85)"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "UPC Cáncer Cervicouterino. Realizar IC en papel más notificación GES de sospecha de patología. Destino HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "UPM Cáncer de Mama. Se realiza IC en papel más notificación GES. Se debe indicar qué mama es. Se deriva a HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Cáncer Gástrico (desde los 40 años). IC en papel, se realiza notificación GES por sospecha. Destino HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Depresión (GES). Deriva por Depresión Refractaria, Síntomas Psicóticos e Ideación Suicida. Se debe notificar a paciente si no tiene caso creado GES. IC en papel a HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Cataratas. IC en papel con destino hacia HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
},
{
 "tipo": "Patología",
 "via": "GES",
 "detalle": "SIC Papel",
 "destino": "Hospital Base Valdivia",
 "ges": "Si",
 "descripcion": "Retinopatía Diabética. IC en papel con derivación a HBV.",
 "imagen": "https://placehold.co/80x80/198754/ffffff?text=GES"
}
]

// (Req #4) Mapa de color por tipo (para la banda superior de la card)
const tipoColorMap = {
  'Especialidad': '#6b7cff',
  'Procedimiento': '#13b1a8',
  'Patología': '#f06784',
  'Patologia': '#f06784' // Alias sin tilde
};
 
// (Req #1) Utilidades de búsqueda
// Normaliza para búsqueda/compare (sin tildes, lower, trim)
const norm = (v) => String(v ?? '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
// Debounce simple
const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

// Variables globales
let filteredData = [...referralData];

// Pagination state: track the current page and number of items per page
// The pageSize can be adjusted to show more or fewer records per page.
let currentPage = 1;
const pageSize = 20;
let currentGesFilter = 'all';
let isTableView = false;
let isKpiBarView = false; // Estado para la vista del dashboard (píldoras/gráfico)

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIO: Script para fecha y hora ---
    try {
        const now = new Date();
        // Opciones para Chile (es-CL)
        const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false };
        
        const dateString = now.toLocaleDateString('es-CL', optionsDate);
        const timeString = now.toLocaleTimeString('es-CL', optionsTime);
        
        // Capitalizar la primera letra del día
        const finalDateString = dateString.charAt(0).toUpperCase() + dateString.slice(1);
        
        // Formato final: "Martes, 5 de noviembre de 2024 | 14:30 hrs."
        const dateTimeString = `${finalDateString} | ${timeString} hrs.`;
        
        const el = document.getElementById('currentDateTime');
        if (el) {
            el.textContent = dateTimeString;
        }
    } catch (e) {
        // Fallback en caso de error
        console.error("Error al actualizar la fecha y hora:", e);
        const el = document.getElementById('currentDateTime');
        if (el) {
            el.textContent = "Error al cargar hora";
        }
    }
    // --- FIN: Script para fecha y hora ---

    // (Req #7) Año automático para el Footer
    try {
        document.getElementById('year').textContent = new Date().getFullYear();
    } catch(e) {
        console.error("Error al setear el año:", e);
    }

    initializeFilters();
    renderResults();
    setupEventListeners();
});

// (Req #3) Filtros limpios y ordenados
function initializeFilters() {
 // Poblar destinos únicos (trim + sin tildes para ordenar, pero mostrando original)
 const destinoSelect = document.getElementById('filterDestino');
 const uniq = new Map();
 referralData.forEach(it => {
   const raw = (it.destino ?? '').trim();
   if (!raw) return;
   const key = norm(raw);
   if (!uniq.has(key)) uniq.set(key, raw);
 });
 [...uniq.values()].sort((a,b)=> a.localeCompare(b, 'es')).forEach(dest => {
   const opt = document.createElement('option');
   opt.value = dest;
   opt.textContent = dest;
   destinoSelect.appendChild(opt);
 });

 // Total
 document.getElementById('totalCount').textContent = referralData.length;
}


// Configurar event listeners
function setupEventListeners() {
    // (Req #1) Búsqueda general (con debounce)
    document.getElementById('searchGeneral').addEventListener('input', debounce(applyFilters, 180));
     
    // Filtros de selección
    document.getElementById('filterTipo').addEventListener('change', applyFilters);
    document.getElementById('filterVia').addEventListener('change', applyFilters);
    document.getElementById('filterDestino').addEventListener('change', applyFilters);
     
    // Botones GES
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentGesFilter = this.getAttribute('data-ges');
            applyFilters();
        });
    });
     
    // Limpiar filtros
    document.getElementById('btnClearFilters').addEventListener('click', clearFilters);
     
    // Toggle vista
    document.getElementById('btnToggleView').addEventListener('click', toggleView);
     
    // Exportar CSV
    // (Req: btnExport no está en el HTML final, pero se deja el listener por si se re-activa)
    const btnExport = document.getElementById('btnExport');
    if (btnExport) {
        btnExport.addEventListener('click', exportToCSV);
    }
     
    // Toggle densidad
    const btnDensity = document.getElementById('btnDensity');
    if (btnDensity) {
        btnDensity.addEventListener('click', (e)=>{
            document.body.classList.toggle('compact');
            // Feedback en el botón
            const btn = e.currentTarget;
            if (document.body.classList.contains('compact')) {
                btn.innerHTML = '<i class="bi bi-arrows-expand"></i> Normal';
            } else {
                btn.innerHTML = '<i class="bi bi-arrows-collapse"></i> Compacta';
            }
        });
    }
     
    // Toggle vista KPI (Píldoras/Gráfico)
    const btnKpiToggle = document.getElementById('btnKpiToggle');
    if (btnKpiToggle) {
        btnKpiToggle.addEventListener('click', (e) => {
            isKpiBarView = !isKpiBarView;
            const btn = e.currentTarget;
            if (isKpiBarView) {
                btn.innerHTML = '<i class="bi bi-tags-fill"></i> Píldoras';
                btn.classList.add('active');
            } else {
                btn.innerHTML = '<i class="bi bi-bar-chart-line"></i> Gráfico';
                btn.classList.remove('active');
            }
            renderMiniKpis(); // Re-render solo los KPIs
        });
    }
     
    // (Req #5) Atajos de teclado
    document.addEventListener('keydown', (e)=>{
     // No activar si estamos escribiendo en un input
     if (e.target.matches('input,select,textarea')) return;
     
     const k = e.key.toLowerCase();
     
     if (k === '/') { 
         e.preventDefault(); 
         document.getElementById('searchGeneral').focus(); 
     }
     if (k === 't') { 
         e.preventDefault(); 
         toggleView(); 
     }
     if (k === 'c') { 
         e.preventDefault(); 
         clearFilters(); 
     }
     if (k === 'g') { 
       e.preventDefault();
       const order = ['all','Si','No'];
       const idx = order.indexOf(currentGesFilter);
       currentGesFilter = order[(idx+1)%order.length];
       // Sincroniza botones
       document.querySelectorAll('.btn-filter').forEach(b=>{
         b.classList.toggle('active', b.getAttribute('data-ges')===currentGesFilter);
       });
       applyFilters();
     }
    });

    // Mini search synchronizes with the main search input
    const miniSearch = document.getElementById('miniSearch');
    if (miniSearch) {
        miniSearch.addEventListener('input', debounce(() => {
            const val = miniSearch.value;
            const mainInput = document.getElementById('searchGeneral');
            if (mainInput) mainInput.value = val;
            applyFilters();
        }, 180));
    }

    // Mini clear button resets all filters
    const miniClear = document.getElementById('miniClear');
    if (miniClear) {
        miniClear.addEventListener('click', () => {
            clearFilters();
        });
    }

    // Mini toggle view mirrors the main toggle
    const miniToggle = document.getElementById('miniToggleView');
    if (miniToggle) {
        miniToggle.addEventListener('click', () => {
            toggleView();
        });
    }

    // Back-to-top button functionality
    const btnBackTop = document.getElementById('btnBackTop');
    if (btnBackTop) {
        btnBackTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        window.addEventListener('scroll', () => {
            btnBackTop.style.display = window.scrollY > 200 ? 'flex' : 'none';
        });
    }
}

// (Req #2) Filtros y búsqueda robustos
function applyFilters() {
  const searchText = norm(document.getElementById('searchGeneral').value);
  const filterTipo    = norm(document.getElementById('filterTipo').value);
  const filterVia     = norm(document.getElementById('filterVia').value);
  const filterDestino = norm(document.getElementById('filterDestino').value);

  filteredData = referralData.filter(item => {
    // Texto libre: inspecciona solo strings útiles
    const hayBusqueda = searchText.length > 0;
    const matchesSearch = !hayBusqueda || [
      'tipo','via','detalle','destino','ges','descripcion'
    ].some(k => norm(item[k]).includes(searchText));

    // Selects tolerantes (sin tildes/caso/espacios)
    const matchesTipo    = !filterTipo    || norm(item.tipo)    === filterTipo;
    const matchesVia     = !filterVia     || norm(item.via)     === filterVia;
    const matchesDestino = !filterDestino || norm(item.destino) === filterDestino;

    // Botonera GES
    const g = norm(item.ges);
    const matchesGes = (currentGesFilter === 'all') ||
                       (currentGesFilter === 'Si' && (g === 'si' || g === 'sí')) ||
                       (currentGesFilter === 'No' && (g === 'no' || g === '' || g === 'null'));

    return matchesSearch && matchesTipo && matchesVia && matchesDestino && matchesGes;
  });

  // Whenever filters change we reset the current page to the first page
  currentPage = 1;
  renderResults();
}


// Renderizar resultados
function renderResults() {
    // Update result counts in both regular and mini bars
    document.getElementById('resultsCount').textContent = filteredData.length;
    const miniResultsEl = document.getElementById('miniResults');
    if (miniResultsEl) {
        miniResultsEl.textContent = filteredData.length;
    }

    // Synchronize search inputs so they reflect the same value
    const searchInput = document.getElementById('searchGeneral');
    const miniSearch = document.getElementById('miniSearch');
    if (searchInput && miniSearch && miniSearch.value !== searchInput.value) {
        miniSearch.value = searchInput.value;
    }

    if (filteredData.length === 0) {
        document.getElementById('cardsView').innerHTML = '';
        document.getElementById('tableBody').innerHTML = '';
        document.getElementById('noResults').style.display = 'block';
    } else {
        document.getElementById('noResults').style.display = 'none';
    }

    // Determine which slice of results to display for the current page
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = filteredData.slice(start, end);

    if (isTableView) {
        renderTableView(pageData);
    } else {
        renderCardsView(pageData);
    }

    // Render pagination controls
    renderPagination();

    // (Req #4) Render KPI Bar
    renderMiniKpis();

    // Scroll to the top of the results container when new results are rendered
    scrollToResultsTop();
}

// Renderizar vista de cards
function renderCardsView(data = filteredData) {
    const container = document.getElementById('cardsView');
    container.innerHTML = '';
    data.forEach((item, index) => {
        // Adjust index to reflect its position in the full filtered list
        const globalIndex = (currentPage - 1) * pageSize + index;
        const card = createCard(item, globalIndex);
        container.appendChild(card);
    });
}

// Crear card individual
function createCard(item, index) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 d-flex align-items-stretch fade-in';
     
    const tipoBadgeClass = getTipoBadgeClass(item.tipo);
    const ges = String(item.ges).toLowerCase();
    const isGes = ges === 'si' || ges === 'sí';
    const gesBadgeClass = isGes ? 'badge-ges-si' : 'badge-ges-no';
    const gesText = isGes ? 'GES' : 'No GES';

    col.innerHTML = `
        <div class="card card-referral w-100" style="--tipo-color:${tipoColorMap[item.tipo] || 'var(--color-medical)'}">
            <div class="card-header-custom">
                <span class="badge badge-custom ${tipoBadgeClass}">${item.tipo || 'N/A'}</span>
                <span class="badge badge-custom ${gesBadgeClass}">${gesText}</span>
            </div>
            <div class="card-body-custom">
                <div class="info-container">
                    <div class="info-row">
                        <i class="bi bi-file-text"></i>
                        <div>
                            <span class="info-label">Descripción:</span>
                            <!-- (Req #6) Trim de la descripción -->
                            <div class="info-value">${(item.descripcion || 'N/A').trim()}</div>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="bi bi-arrow-right-circle"></i>
                        <div>
                            <span class="info-label">Vía:</span>
                            <span class="info-value">${item.via || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="bi bi-info-circle"></i>
                        <div>
                            <span class="info-label">Detalle:</span>
                            <span class="info-value">${item.detalle || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <i class="bi bi-geo-alt"></i>
                        <div>
                            <span class="info-label">Destino:</span>
                            <span class="info-value">${item.destino || 'N/A'}</span>
                        </div>
                    </div>
                    
                    ${item.imagen ? `
                    <div class="info-row">
                        <i class="bi bi-image"></i>
                        <div>
                            <span class="info-label">Documento:</span>
                            <br>
                            <img src="${item.imagen}" alt="Documento" class="image-papel mt-2" onerror="this.src='https://placehold.co/80x80/6c757d/ffffff?text=Error'">
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard(event, ${index})">
                        <i class="bi bi-clipboard"></i> Copiar Info
                    </button>
                </div>
            </div>
        </div>
    `;

    return col;
}

// Renderizar vista de tabla
function renderTableView(data = filteredData) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    data.forEach((item, index) => {
        const globalIndex = (currentPage - 1) * pageSize + index;
        const row = createTableRow(item, globalIndex);
        tbody.appendChild(row);
    });
}

// Render pagination controls below the results. This function builds simple
// previous/next buttons and a small range of page numbers. When a
// pagination control is clicked the currentPage variable is updated and
// renderResults() is called to refresh the page.
function renderPagination() {
    const container = document.getElementById('pagination');
    if (!container) return;
    container.innerHTML = '';
    const totalPages = Math.ceil(filteredData.length / pageSize);
    if (totalPages <= 1) {
        return;
    }
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'btn btn-outline-secondary btn-sm';
    prevBtn.textContent = '‹ Anterior';
    prevBtn.disabled = currentPage === 1;
    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderResults();
        }
    });
    container.appendChild(prevBtn);
    // Determine range of pages to show (max 5 numbers)
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    for (let p = startPage; p <= endPage; p++) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-secondary btn-sm';
        btn.textContent = p;
        if (p === currentPage) {
            btn.classList.add('active');
            // Use primary style for active
            btn.classList.add('btn-primary');
        }
        btn.addEventListener('click', () => {
            currentPage = p;
            renderResults();
        });
        container.appendChild(btn);
    }
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'btn btn-outline-secondary btn-sm';
    nextBtn.textContent = 'Siguiente ›';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderResults();
        }
    });
    container.appendChild(nextBtn);
}

// Scroll the active results container back to the top. When in table view
// we reset the scroll position of the responsive table; when in card view we
// reset the scroll position of the cards container.
function scrollToResultsTop() {
    if (isTableView) {
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) tableContainer.scrollTop = 0;
    } else {
        const cardsContainer = document.getElementById('cardsContainer');
        if (cardsContainer) cardsContainer.scrollTop = 0;
    }
    // Also scroll the page to bring the results section into view
    const miniBar = document.getElementById('miniBar');
    if (miniBar) {
        miniBar.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Crear fila de tabla
function createTableRow(item, index) {
    const tr = document.createElement('tr');
    tr.className = 'fade-in';
     
    const tipoBadgeClass = getTipoBadgeClass(item.tipo);
    const ges = String(item.ges).toLowerCase();
    const isGes = ges === 'si' || ges === 'sí';
    const gesBadgeClass = isGes ? 'badge-ges-si' : 'badge-ges-no';
    const gesText = isGes ? 'GES' : 'No GES';

    tr.innerHTML = `
        <td><span class="badge badge-custom ${tipoBadgeClass}">${item.tipo || 'N/A'}</span></td>
        <td>${(item.descripcion || 'N/A').trim()}</td>
        <td>${item.via || 'N/A'}</td>
        <td>${item.destino || 'N/A'}</td>
        <td><span class="badge badge-custom ${gesBadgeClass}">${gesText}</span></td>
        <td>${item.detalle || 'N/A'}</td>
    `;
    return tr;
}

// --- FUNCIONES AUXILIARES ---
 
// (Req #4 + Gráfico) KPI Bar con dos vistas
function renderMiniKpis(){
  const kpiContainer = document.getElementById('miniKpis');
   
  if (filteredData.length === 0) {
      kpiContainer.innerHTML = '<span class="text-muted small">Sin agrupaciones para mostrar</span>';
      kpiContainer.className = 'd-flex gap-2 flex-wrap flex-grow-1';
      return;
  }

  const group = (key)=> filteredData.reduce((acc,it)=>{
    const k = (String(it[key] ?? '').trim() === '') ? 'N/A' : (it[key] ?? 'N/A');
    acc[k] = (acc[k]||0)+1; return acc;
  },{});
   
  const tipo = group('tipo');
  const via  = group('via');
  const ges  = filteredData.reduce((a,it)=>{
    const g = norm(it.ges);
    const bucket = (g === 'si' || g === 'sí') ? 'GES' : (g === 'no' || g === '' || g === 'null') ? 'No GES' : 'N/A';
    a[bucket] = (a[bucket]||0)+1; return a;
  }, {});

  // --- Lógica de Vistas ---
   
  if (isKpiBarView) {
    // VISTA DE GRÁFICO
    kpiContainer.className = 'kpi-bars flex-grow-1'; // Usar estilos de barra
     
    const createBarGroup = (title, data, colorFn) => {
        const total = Object.values(data).reduce((s, c) => s + c, 0);
        if (total === 0) return '';
        
        const maxVal = Math.max(1, ...Object.values(data)); // Evitar div por cero
        
        return `
            <div class="kpi-group">
                <div class="kpi-group-title">${title} (${total})</div>
                ${Object.entries(data).sort((a,b)=>b[1]-a[1]).map(([k,n]) => {
                    const [cls, textCls] = colorFn(k);
                    const perc = (n / maxVal) * 100;
                    return `
                    <div class="kpi-bar-item" title="${k}: ${n}">
                        <div class="kpi-bar-label">${k}</div>
                        <div class="kpi-bar-track">
                            <div class="kpi-bar-fill ${cls}" style="width: ${perc}%;">
                                <span class="kpi-bar-value ${textCls}">${n}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('')}
            </div>
        `;
    };
     
    const tipoColorFn = (k) => [getTipoBadgeClass(k), (k === 'Procedimiento' ? 'text-dark' : 'text-white')]; // Procedimiento es claro
    const viaColorFn  = (k) => ['bg-info', 'text-dark'];
    const gesColorFn  = (k) => {
        if (k === 'GES') return ['badge-ges-si', 'text-dark'];
        if (k === 'No GES') return ['badge-ges-no', 'text-white'];
        return ['bg-secondary', 'text-white'];
    };

    kpiContainer.innerHTML = `
        ${createBarGroup('Por Tipo', tipo, tipoColorFn)}
        ${createBarGroup('Por Vía', via, viaColorFn)}
        ${createBarGroup('Por GES', ges, gesColorFn)}
    `;

  } else {
    // VISTA DE PÍLDORAS (Req #4)
    kpiContainer.className = 'd-flex gap-2 flex-wrap flex-grow-1'; // Estilos por defecto
     
    const textClsForBadge = (cls) => {
      return (cls.includes('bg-info') || cls.includes('badge-ges-si') || cls.includes('badge-tipo-procedimiento')) ? 'text-dark' : 'text-white';
    }
     
    const pill = (txt,n,cls, extra='')=> `<span class="badge ${cls} ${extra} rounded-pill px-3 py-2" style="font-size:.75rem;">${txt}: <strong>${n}</strong></span>`;
     
    const html = [
      ...Object.entries(tipo).sort((a,b)=>b[1]-a[1]).map(([k,n])=>{
          const cls = getTipoBadgeClass(k);
          return pill(k,n,cls, textClsForBadge(cls));
      }),
      ...Object.entries(via ).sort((a,b)=>b[1]-a[1]).map(([k,n])=>pill(k,n,'bg-info','text-dark')),
      ...Object.entries(ges ).sort((a,b)=>b[1]-a[1]).map(([k,n])=>{
          const cls = (k==='GES' ? 'badge-ges-si' : (k==='No GES'?'badge-ges-no':'bg-secondary'));
          return pill(k, n, cls, textClsForBadge(cls));
      })
    ].join(' ');
     
    kpiContainer.innerHTML = html;
  }
}


// Obtener clase de badge por tipo
function getTipoBadgeClass(tipo) {
    if (!tipo) return 'bg-secondary';
    switch (String(tipo).toLowerCase()) {
        case 'especialidad':
            return 'badge-tipo-especialidad';
        case 'procedimiento':
            return 'badge-tipo-procedimiento';
        case 'patología':
        case 'patologia': // Contempla la falta de tilde
            return 'badge-tipo-patologia';
        default:
            return 'bg-dark';
    }
}

// Copiar al portapapeles
window.copyToClipboard = function(event, index) {
    const item = filteredData[index];
    const textToCopy = [
        `Derivación: ${(item.descripcion || 'N/A').trim()}`,
        `Tipo: ${item.tipo || 'N/A'}`,
        `Vía: ${item.via || 'N/A'}`,
        `Destino: ${item.destino || 'N/A'}`,
        `Detalle: ${item.detalle || 'N/A'}`,
        `GES: ${item.ges || 'N/E'}`
    ].join('\n');

    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    textarea.style.position = 'fixed';
    textarea.style.top = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();

    let copySuccess = false;
    try {
        copySuccess = document.execCommand('copy');
    } catch (err) {
        console.error('Error al copiar:', err);
    }
    document.body.removeChild(textarea);

    // Retroalimentación visual en el botón
    if (event && event.target && copySuccess) {
        const btn = event.target.closest('button');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Copiado';
            btn.disabled = true;
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            }, 2000);
        }
    }
}

// Limpiar filtros
function clearFilters() {
    document.getElementById('searchGeneral').value = '';
    document.getElementById('filterTipo').value = '';
    document.getElementById('filterVia').value = '';
    document.getElementById('filterDestino').value = '';

    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-ges') === 'all') {
            btn.classList.add('active');
        }
    });
    currentGesFilter = 'all';
     
    // Reset density
    const btnDensity = document.getElementById('btnDensity');
    if (btnDensity) {
        document.body.classList.remove('compact');
        btnDensity.innerHTML = '<i class="bi bi-arrows-collapse"></i> Compacta';
    }
     
    // Reset KPI view
    const kpiBtn = document.getElementById('btnKpiToggle');
    if (kpiBtn) {
        isKpiBarView = false;
        kpiBtn.innerHTML = '<i class="bi bi-bar-chart-line"></i> Gráfico';
        kpiBtn.classList.remove('active');
    }

    applyFilters();
}

// Cambiar vista
function toggleView() {
    isTableView = !isTableView;

    const btn = document.getElementById('btnToggleView');
    const miniBtn = document.getElementById('miniToggleView');
    const cardsView = document.getElementById('cardsView');
    const tableView = document.getElementById('tableView');

    if (isTableView) {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
        const label = '<i class="bi bi-card-list"></i> Vista Cards (t)';
        if (btn) btn.innerHTML = label;
        if (miniBtn) miniBtn.innerHTML = label;
    } else {
        cardsView.style.display = '';
        tableView.style.display = 'none';
        const label = '<i class="bi bi-grid-3x3"></i> Vista Tabla (t)';
        if (btn) btn.innerHTML = label;
        if (miniBtn) miniBtn.innerHTML = label;
    }

    renderResults();
}

// Sanitizar valor para CSV
function sanitizeCSV(value) {
    if (value == null) return '';
    let str = String(value);
    if (str.includes(',') || str.includes('\n') || str.includes('"')) {
        str = str.replace(/"/g, '""');
        return `"${str}"`;
    }
    return str;
}

// Exportar a CSV
function exportToCSV() {
    const headers = ["Tipo", "Descripcion", "Via", "Destino", "GES", "Detalle"];
    let csvContent = headers.join(',') + '\n';

    filteredData.forEach(item => {
        const row = [
            sanitizeCSV(item.tipo),
            sanitizeCSV(item.descripcion),
            sanitizeCSV(item.via),
            sanitizeCSV(item.destino),
            sanitizeCSV(item.ges),
            sanitizeCSV(item.detalle)
        ];
        csvContent += row.join(',') + '\n';
    });

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para UTF-8
    const link = document.createElement('a');
    if (link.download !== undefined) { 
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'derivaciones_cesfam_la_union.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}
